### Confederation Types ###

## Defensive League
defensive_league_type = {

	# Checks if a character can join the defensive league
	#
	# root - The league that's being joined.
	# scope:character - The character who can be expected to be a living ruler
	#
	is_valid_member_character = {
		scope:character = {
			CL_uses_leagues = yes # Needs to have a relevant government
			top_liege ?= this # Needs to be independent
			CL_has_appropriate_title_tier = yes # Must have an appropriate title tier
		}
	}

	# Fired when a character joins the defensive league
	#
	# root - The league that's being joined.
	# scope:character - Character joining the league.
	#
	on_member_character_joined = {
		save_scope_as = confederation
		# Mark character and their vassals as new confederates.
		scope:character = {
			save_scope_as = joiner
			if = {
				limit = { has_character_flag = new_confederate }
				remove_character_flag = new_confederate
			}
			add_character_flag = {
				flag = new_confederate
				years = 3
			}
			every_vassal_or_below = {
				if = {
					limit = { has_character_flag = new_confederate }
					remove_character_flag = new_confederate
				}
				if = {
					limit = { highest_held_title_tier >= tier_county }
					add_character_flag = {
						flag = new_confederate
						years = 3
					}
				}
			}
		}
		# Notify all other members about them joining.
		every_player = {
			limit = { confederation = scope:confederation }
			send_interface_message = {
				type = msg_joined_confederation
				title = msg_joined_league
				desc = msg_joined_league_desc
				left_icon = scope:character
			}
		}
	}

	# Fired when a character leaves the defensive league
	#
	# root - The league that's being left.
	# scope:character - Character leaving the league.
	#
	on_member_character_left = {
		save_scope_as = confederation
		scope:character = {
			save_scope_as = left_confederation
			if = {
				limit = { has_character_modifier = mpo_confederation_member_modifier }
				remove_character_modifier = mpo_confederation_member_modifier
			}
			if = {
				limit = { has_character_flag = new_confederate }
				remove_character_flag = new_confederate
			}
			every_vassal_or_below = {
				if = {
					limit = { has_character_modifier = mpo_confederation_member_modifier }
					remove_character_modifier = mpo_confederation_member_modifier
				}
				if = {
					limit = { has_character_flag = new_confederate }
					remove_character_flag = new_confederate
				}
			}
		}

		# If league is being destroyed, delete from global variable list
		if = {
			limit = {
				NOT = {
					any_confederation_member = { this != scope:left_confederation }
				}
			}
		}

		# Send notification for misc leaving
		if = {
			limit = {
				scope:left_confederation = {
					NOR = {
						has_character_flag = migrating_from_confederation
						has_variable = left_confederation
					}
				}
			}
			# Notify all members about them leaving.
			every_player = {
				limit = {
					confederation = scope:confederation
					this != scope:left_confederation
				}
				send_interface_message = {
					type = msg_broken_confederation
					title = msg_broken_league
					desc = msg_broken_league_desc
					left_icon = scope:left_confederation
				}
			}
			scope:left_confederation = {
			   send_interface_message = {
					type = msg_broken_confederation
					title = msg_broken_league_root
					desc = msg_broken_league_desc_root
					left_icon = confederation
			   }
			}
		}
	}
}


## Nomadic Confederation
# Overwriting base game definition to make sure it properly works with the League/Confederation government split
nomadic_confederation = {

	# Checks if a character can join the nomadic confederation
	#
	# root - The confederation that's being joined.
	# scope:character - The character who can be expected to be a living ruler
	#
	is_valid_member_character = {
		scope:character = {
			CL_uses_confederations = yes # Needs to have a relevant government
			top_liege ?= this # Needs to be independent
			CL_has_appropriate_title_tier = yes # Must have an appropriate title tier
		}
	}

	# Fired when a character joins the nomadic confederation
	#
	# root - The confederation that's being joined.
	# scope:character - Character joining the confederation.
	#
	on_member_character_joined = {
		save_scope_as = confederation
		# Mark character and their vassals as new confederates.
		scope:character = {
			save_scope_as = joiner
			if = {
				limit = { has_character_flag = new_confederate }
				remove_character_flag = new_confederate
			}
			add_character_flag = {
				flag = new_confederate
				years = 3
			}
			every_vassal_or_below = {
				if = {
					limit = { has_character_flag = new_confederate }
					remove_character_flag = new_confederate
				}
				if = {
					limit = { highest_held_title_tier >= tier_county }
					add_character_flag = {
						flag = new_confederate
						years = 3
					}
					if = {
						limit = { government_has_flag = government_is_nomadic }
						add_character_modifier = {
							modifier = mpo_confederation_member_modifier
							years = 5
						}
					}
				}
			}
		}
		# Notify all other members about them joining.
		every_player = {
			limit = { confederation = scope:confederation }
			send_interface_message = {
				type = msg_joined_confederation
				title = msg_joined_confederation
				desc = msg_joined_confederation_desc
				left_icon = scope:character
			}
		}
	}

	# Fired when a character leaves the nomadic confederation
	#
	# root - The confederation that's being left.
	# scope:character - Character leaving the confederation.
	#
	on_member_character_left = {
		save_scope_as = confederation
		scope:character = {
			save_scope_as = left_confederation
			if = {
				limit = { has_character_modifier = mpo_confederation_member_modifier }
				remove_character_modifier = mpo_confederation_member_modifier
			}
			if = {
				limit = { has_character_flag = new_confederate }
				remove_character_flag = new_confederate
			}
			every_vassal_or_below = {
				if = {
					limit = { has_character_modifier = mpo_confederation_member_modifier }
					remove_character_modifier = mpo_confederation_member_modifier
				}
				if = {
					limit = { has_character_flag = new_confederate }
					remove_character_flag = new_confederate
				}
			}
		}

		# If confederation is being destroyed, delete from global variable list
		if = {
			limit = {
				NOT = {
					any_confederation_member = { this != scope:left_confederation }
				}
			}
		}

		# Send notification for misc leaving
		if = {
			limit = {
				scope:left_confederation = {
					NOR = {
						has_character_flag = migrating_from_confederation
						has_variable = left_confederation
					}
				}
			}
			# Notify all members about them leaving.
			every_player = {
				limit = {
					confederation = scope:confederation
					this != scope:left_confederation
				}
				# C&L: Base game gives out a notification saying the character joined the confederation, instead of leaving the confederation
				send_interface_message = {
					type = msg_broken_confederation
					title = msg_broken_confederation_no_migrate
					desc = msg_broken_confederation_desc_no_migrate
					left_icon = scope:left_confederation
				}
			}
			scope:left_confederation = {
			   send_interface_message = {
					type = msg_broken_confederation
					title = msg_broken_confederation_no_migrate_root
					desc = msg_broken_confederation_desc_no_migrate_root
					left_icon = confederation
			   }
			}
		}
	}
}
