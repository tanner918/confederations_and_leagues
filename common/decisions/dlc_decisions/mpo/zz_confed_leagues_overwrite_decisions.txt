########################
## From dlc_decisions\mpo\mpo_decisions.txt
########################
# All changes I make here will be noted with comments started by: C&L

call_for_confederation_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/mpo_decision_confederation.dds"
	}
	decision_group_type = major
	ai_check_interval = 8

	# C&L: Made name change depending on which government you have, which determines whether you can form a "League" or a "Confederation"
	title = {
		first_valid = {
			triggered_desc = {
				trigger = {
					CL_uses_leagues = yes
				}
				desc = call_for_league_decision
			}
			desc = call_for_confederation_decision
		}
	}

	desc = call_for_confederation_decision_desc

	# C&L: Made decision tooltip change depending on which government you have, which determines whether you can form a "League" or a "Confederation"
	selection_tooltip = {
		first_valid = {
			triggered_desc = {
				trigger = {
					CL_uses_leagues = yes
				}
				desc = call_for_league_decision_tooltip
			}
			desc = call_for_confederation_decision_tooltip
		}
	}

	is_shown = {
		highest_held_title_tier <= tier_duchy # C&L: Might change this if I decide to allow kingdoms into confederations/leagues. If I do, will likely need to include stricter restrictions on them, like smaller realm sizes
		OR = {
			# C&L: Base game just checks if you are Tribal/Nomadic. Changed it to check that you have any of the valid governments
			CL_uses_confederations = yes
			CL_uses_leagues = yes
		}
		is_playable_character = yes
		is_independent_ruler = yes
		NOR = {
			has_character_flag = forming_confederation
			is_confederation_member = yes
		}
	}

	is_valid = {
		is_independent_ruler = yes
		highest_held_title_tier <= tier_duchy # C&L: Might change this if I decide to allow kingdoms into leagues/confederations
		is_tributary = no
		custom_tooltip = { # C&L: Base game just checks if you are Tribal/Nomadic. Changed it to check that you have any of the valid governments, and shows proper tooltip
			OR = {
				CL_uses_confederations = yes
				CL_uses_leagues = yes
			}
			text = CL_has_valid_government_tt
		}
		trigger_if = { # C&L: Base game just checks if you have Nomadic government, and fallsback to assuming you are Tribal. I changed it so that it now checks what realm law you use, and makes sure you only have the relevant laws
			limit = {
				realm_law_use_nomadic_authority = yes
			}
			OR = {
				has_realm_law = nomadic_authority_1
				has_realm_law = nomadic_authority_2
			}
		}
		trigger_else_if = {
			limit = {
				realm_law_use_tribal_authority = yes
			}
			OR = {
				has_realm_law = tribal_authority_0
				has_realm_law = tribal_authority_1
				has_realm_law = tribal_authority_2
			}
		}
		trigger_else_if = {
			limit = {
				realm_law_use_crown_authority = yes
			}
			OR = {
				has_realm_law = crown_authority_0
				has_realm_law = crown_authority_1
				has_realm_law = crown_authority_2
			}
		}
		NOR = {
			has_trait = conqueror
			has_trait = greatest_of_khans
		}
		OR = {
			has_trait = diplomat
			has_trait = family_first
			confederation_foe_trigger = { CHARACTER = root }
		}
		#This is just meant to stop player exploits
		trigger_if = { # C&L: Made this tooltip change depending on whether you will be in a Defensive League or Confederation
			limit = {
				is_ai = no
				CL_uses_leagues = yes
			}
			custom_tooltip = {
				text = recently_took_leave_league_decision_tt
				NOT = { has_variable = left_confederation }
			}
		}
		trigger_else_if = {
			limit = {
				is_ai = no
				CL_uses_confederations = yes
			}
			custom_tooltip = {
				text = recently_took_leave_confederation_decision_tt
				NOT = { has_variable = left_confederation }
			}
		}
	}
	cooldown = { years = 5 }

	is_valid_showing_failures_only = {
		age >= 6
		trigger_if = {
			limit = {
				is_ai = no
			}
			NOT = { exists = involved_activity }
			NOT = { has_trait = infirm }
			is_physically_able = yes
			is_travelling = no
		}
		trigger_else = {
			is_imprisoned = no
			is_incapable = no
			is_alive = yes
			is_migrating = no
			NOT = { has_trait = infirm }
		}
	}

	cost = {
		prestige = {
			value = {
				add = 100
				if = {
					limit = {
						highest_held_title_tier = tier_duchy # C&L: If I decide to allow kingdoms into confederations/leagues, will likely need to add a check for if their highest held tier is kingdom, to increase the cost further for them
					}
					add = 200
				}
				if = {
					limit = {
						max_military_strength > 0
						any_neighboring_top_liege_realm_owner = {
							NOT = { is_allied_to = root }
							max_military_strength > 0
							confederation_worthy_foe_strength_ratio_value_root <= 0.5
						}
					}
					add = -50
				}
				if = {
					limit = {
						max_military_strength > 0
						any_neighboring_top_liege_realm_owner = {
							NOT = { is_allied_to = root }
							max_military_strength > 0
							confederation_worthy_foe_strength_ratio_value_root <= 0.25
						}
					}
					add = -50
				}
			}
		}
		piety = {
			value = {
				add = 250
			}
		}
	}

	effect = {
		# C&L: Made tooltips shown depend on whether you will be forming a "Confederation" or a "League"
		if = {
			limit = {
				CL_uses_leagues = yes
			}
			custom_tooltip = enables_offer_league_tt
			custom_tooltip = offer_league_members_tt
			custom_tooltip = league_join_defensive_wars_tt
			custom_tooltip = league_raiding_attacking_tt
			custom_tooltip = offer_league_5_year_warning_tt
		}
		else = {
			custom_tooltip = enables_offer_confederation_tt
			custom_tooltip = offer_confederation_members_tt
			custom_tooltip = confederation_join_defensive_wars_tt
			custom_tooltip = confederation_raiding_attacking_tt
			custom_tooltip = offer_confederation_5_year_warning_tt
		}
		if = {
			limit = {
				government_has_flag = government_is_nomadic
			}
			custom_tooltip = confederation_modifier_tt
		}
		# C&L: Base game just checks if you have Nomadic government, and fallsback to assuming you are Tribal. I changed it so that it now checks what realm law you use, and notifies you that that specific realm law will be limited
		if = {
			limit = {
				realm_law_use_nomadic_authority = yes
			}
			custom_tooltip = confederation_restrictions_warning_tt
		}
		else_if = {
			limit = {
				realm_law_use_tribal_authority = yes
			}
			custom_tooltip = confederation_restrictions_tribe_warning_tt
		}
		else_if = {
			limit = {
				realm_law_use_crown_authority = yes
			}
			custom_tooltip = league_restrictions_crown_authority_warning_tt
		}
		# C&L: Base game explains that rulers can leave the confederation after a while. I changed it so that it properly reflects which confederation/league you are going to be in
		if = {
			limit = {
				CL_uses_confederations = yes
			}

			if = {
				limit = {
					government_has_flag = government_is_nomadic
				}
				custom_tooltip = confederation_migrating_leaving_warning_tt
			}
			else = {
				custom_tooltip = confederation_leaving_warning_tt
			}
		}
		else = {
			custom_tooltip = league_leaving_warning_tt
		}
		trigger_event = mpo_decisions_events.0001
	}

	ai_potential = {
		OR = {
			# C&L: Base game checks if AI is Tribal/Nomadic. I changed it to just check if their government can actually join a confederation/league
			CL_uses_confederations = yes
			CL_uses_leagues = yes
		}
		is_independent_ruler = yes
		highest_held_title_tier <= tier_duchy # C&L: Might change this if I decide to allow kingdoms into confederations/leagues.
		is_tributary = no
		is_playable_character = yes
		is_confederation_member = no
		is_alive = yes
		#Culture friends # C&L: This requires that the AI has at least two neighbors of the same culture who either: have the same faith; also have unreformed faiths; or whose faith doesn't view their own faith as Hostile/Evil. Might add an alternative to this so that they don't need to same-culture neighbors as long as their neighbors have the same faith with certain tenants, so they could maybe form a faith-based confederation/league instead of a culture-based one. (Will likely also need to make the below neighbor check inside its own scripted trigger so that it could be referenced later when deciding whether to make the confederations/leagues culture- or faith-based)
		any_land_neighboring_realm_with_tributaries_owner = {
			count >= 2
			culture = root.culture
			OR = {
				faith = root.faith
				AND = {
					faith = {
						has_doctrine_parameter = unreformed
					}
					root.faith = {
						has_doctrine_parameter = unreformed
					}
				}
				faith = {
					faith_hostility_level = {
						target = root.faith
						value < faith_hostile_level
					}
				}
			}
			valid_confederation_member_trigger = { CHARACTER = root }
			NOT = {
				has_any_bad_relationship_with_character_trigger = { CHARACTER = root }
			}
		}
	}

	ai_will_do = {
		base = 0
		modifier = {
			ai_compassion >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_honor >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_boldness <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_sociability >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_greed <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_energy <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_rationality >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_compassion <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_honor <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_boldness >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_sociability <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_greed >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_energy >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_rationality <= low_negative_ai_value
			add = -5
		}
		modifier = {
			OR = {
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					confederation_worthy_foe_strength_ratio_value_root <= 0.25
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					is_tributary = yes
					top_suzerain = {
						confederation_worthy_foe_strength_ratio_value_root <= 0.25
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					is_tributary = yes
					suzerain ?= {
						confederation_worthy_foe_strength_ratio_value_root <= 0.25
					}
				}
			}
			add = 25
		}
		modifier = {
			confederation_neighboring_foe_trigger = { CHARACTER = root }
			add = 30
		}
		modifier = {
			OR = {
				any_land_neighboring_realm_with_tributaries_owner = {
					OR = {
						has_trait = greatest_of_khans
						has_trait = conqueror
						any_owned_story = {
							OR = {
								story_type = story_greatest_of_khans
								story_type = story_mongol_invasion
							}
						}
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					top_suzerain = {
						OR = {
							has_trait = greatest_of_khans
							has_trait = conqueror
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					suzerain ?= {
						OR = {
							has_trait = greatest_of_khans
							has_trait = conqueror
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
			}
			add = 50
		}
		modifier = {
			add = 10
			culture = {
				OR = {
					has_cultural_pillar = ethos_stoic
					has_cultural_pillar = ethos_communal
					has_cultural_pillar = ethos_egalitarian
				}
			}
		}
		modifier = {
			add = -20
			culture = {
				OR = {
					has_cultural_pillar = ethos_bellicose
					has_cultural_pillar = ethos_courtly
					has_cultural_pillar = ethos_bureaucratic
				}
			}
		}
		modifier = {
			add = -100
			prestige <= medium_prestige_value # You cannot afford this
		}
		#Another confederation of your culture already exists
		modifier = {
			any_in_global_list = {
				variable = confederations
				has_variable = confederation_culture
				var:confederation_culture = root.culture
			}
			factor = 0.05
		}
		# C&L: Adding in the possibility that another confederation/league already exists that is based around your faith (will likely need to add an additional trigger that makes this only apply if their faith is capable of making faith-based leagues, and will likely need to modify how much this, and the above modifier, factors the ai_will_do chance, so that they aren't as harsh)
		#Another confederation of your faith already exists
		modifier = {
			any_in_global_list = {
				variable = confederations
				has_variable = confederation_faith
				var:confederation_faith = root.faith
			}
			factor = 0.05
		}
		#There's already another confederation nearby
		modifier = {
			any_in_global_list = {
				variable = confederations
				any_confederation_member = {
					in_diplomatic_range = root
				}
			}
			factor = 0.1
		}
	}
}

leave_confederation_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/mpo_decision_confederation.dds"
	}
	ai_check_interval = 12

	# C&L: Made name change depending on which type of confederation/league you are currently in
	title = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = leave_league_decision
			}
			desc = leave_confederation_decision
		}
	}

	# C&L: Made description change depending on which type of confederation/league you are currently in
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = leave_league_decision_desc
			}
			desc = leave_confederation_decision_desc
		}
	}

	# C&L: Made decision tooltip change depending on which type of confederation/league you are currently in
	selection_tooltip = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = leave_league_decision_tooltip
			}
			desc = leave_confederation_decision_tooltip
		}
	}

	is_shown = {
		is_confederation_member = yes
	}

	is_valid = {
		is_confederation_member = yes
		is_at_war = no
		highest_held_title_tier >= tier_county
	}

	is_valid_showing_failures_only = {
		trigger_if = {
			limit = {
				is_ai = no
			}
			NOT = { exists = involved_activity }
			is_physically_able = yes
			is_travelling = no
		}
		trigger_else = {
			is_alive = yes
			is_imprisoned = no
			is_incapable = no
			NOT = { exists = involved_activity }
		}
	}

	cost = {
		prestige = {
			value = {
				add = medium_prestige_value
				if = { # Cost increases if Gurkhan is doing well
					limit = {
						government_has_flag = government_is_nomadic
						exists = situation:the_great_steppe
						situation:the_great_steppe.situation_top_herd = {
							OR = {
								has_realm_law = nomadic_authority_4
								has_realm_law = nomadic_authority_5
							}
						}
						# C&L: Added this additional check so that this prestige increase only applies to Nomads actually in the Great Steppe
						any_character_situation = {
							this = situation:the_great_steppe
						}
					}
					multiply = 1.5
				}
				if = { # Cost increases if just joined in last couple years
					limit = {
						has_character_flag = new_confederate
					}
					multiply = 2
				}
			}
		}
	}

	effect = {
		set_variable = {
			name = left_confederation
			value = root.confederation
			years = 5
		}
		root.confederation = {
			save_scope_as = confederation
			every_confederation_member = {
				limit = {
					NOT = {
						this = root
					}
				}
				add_to_list = confederation_members
			}
		}
		show_as_tooltip = {
			root.confederation = {
				#Your confederation will survive, it has more members
				if = {
					limit = {
						any_confederation_member = {
							count >= 2
							NOT = {
								this = root
							}
						}
					}
					remove_confederation_member = root
				}
				#Your confederation is toast
				else = {
					disband_confederation = yes
				}
			}
		}
		if = {
			limit = {
				government_has_flag = government_is_nomadic
			}
			show_as_tooltip = {
				remove_character_modifier = mpo_confederation_member_modifier
			}
		}
		# C&L: Made tooltip shown properly reflect whether you were in a league or confederation
		if = {
			limit = {
				root.confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_league
				}
			}
			custom_tooltip = league_members_lose_opinion_tt
		}
		else = {
			custom_tooltip = confederates_lose_opinion_tt
		}
		
		save_scope_as = leaver
		trigger_event = {
			id = mpo_decisions_events.0002
			days = 1
		}
	}

	ai_potential = {
		is_confederation_member = yes
		is_independent_ruler = no
		age >= 12
		is_at_war = no
		is_incapable = no
		NOR = {
			any_land_neighboring_realm_with_tributaries_owner = {
				OR = {
					has_trait = greatest_of_khans
					has_trait = conqueror
					is_gurkhan = yes
				}
			}
			any_land_neighboring_realm_with_tributaries_owner = {
				any_owned_story = {
					OR = {
						story_type = story_mongol_invasion
						story_type = story_greatest_of_khans
					}
				}
			}
			situation:the_great_steppe = {
				any_situation_participant = {
					this = root
				}
				any_situation_participant = {
					OR = {
						has_trait = greatest_of_khans
						has_trait = conqueror
					}
				}
			}
		}
		
		#Will not leave if any confederation member is a good pal
		exists = root.confederation
		NOT = {
			root.confederation = {
				any_confederation_member = {
					OR = {
						has_relation_blood_brother = root
						is_allied_to = root
					}
				}
			}
		}
	}

	ai_will_do = {
		base = 0
		# PERKS
		modifier = { # Only member of culture
			NOT = {
				confederation = {
					any_confederation_member = {
						has_same_culture_as = root
					}
				}
			}
			confederation = {
				any_confederation_member = {
					culture = {
						cultural_acceptance = {
							target = root.culture
							value <= 90
						}
					}
					save_temporary_scope_as = actor
				}
			}
			save_temporary_scope_as = recipient
			add = {
				value = offer_vassalage_acceptance_value
				multiply = -0.5
			}
		}

		# MAIN
		modifier = { #Only member of faith, no pluralism.
			NOR = {
				confederation = {
					any_confederation_member = {
						faith = root.faith
					}
				}
				faith = { has_doctrine = doctrine_pluralism_pluralistic }
			}
			confederation = {
				any_confederation_member = {
					save_temporary_scope_as = confederate
				}
			}
			
			add = {
				value = 30
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = scope:confederate.faith
								value >= faith_hostile_level
							}
						}
					}
					add = 30
				}
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = scope:confederate.faith
								value >= faith_evil_level
							}
						}
					}
					add = 30
				}
			}
		}

		modifier = { #Only member of faith, pluralism.
			NOT = {
				confederation = {
					any_confederation_member = {
						faith = root.faith
					}
				}
			}
			faith = { has_doctrine = doctrine_pluralism_pluralistic }
			confederation = {
				any_confederation_member = {
					save_temporary_scope_as = confederate
				}
			}
			add = {
				value = 15
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = scope:confederate.faith
								value >= faith_hostile_level
							}
						}
					}
					add = 10
				}
				if = {
					limit = {
						faith = {
							faith_hostility_level = {
								target = scope:confederate.faith
								value >= faith_evil_level
							}
						}
					}
					add = 10
				}
			}
		}
		modifier = { #Just fought against other member of confederation
			any_truce_holder = {
				is_member_of_confederation = root.confederation
				NOT = {
					has_purchased_truce_with_char = { TARGET = root }
				}
			}
			add = 50
		}
		modifier = { #I fought an independence war against confederation member
			root = {
				exists = var:independence_war_former_liege
				var:independence_war_former_liege = {
					is_member_of_confederation = root.confederation
				}
			}
			add = 100
		}
		modifier = { #Is wrong government type
			# C&L: Base game just checked if you weren't tribal/nomadic/herder. Changed it so that it now checks if your government doesn't match the type of confederation/league you are currently in
			OR = {
				AND = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_confederation
					}
					NOR = {
						CL_uses_confederations = yes
						government_has_flag = government_is_herder # C&L: Base game checks herder here, so I just added it to align with base game
					}
				}
				AND = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
					CL_uses_leagues = no
				}
			}
			add = 50
		}
		modifier = { # Isolationist tradition
			confederation = {
				any_confederation_member = {
					NOT = {
						culture = root.culture
					}
				}
			}
			root.culture = {
				has_cultural_tradition = tradition_isolationist
			}
			add = 20
		}
		modifier = { # Isolationist tradition and all members are other culture
			confederation = {
				NOT = {
					any_confederation_member = {
						culture = root.culture
						NOT = {
							this = root
						}
					}
				}
			}
			root.culture = {
				has_cultural_tradition = tradition_isolationist
			}
			add = 50
		}
		modifier = { # Isolationist tradition
			confederation = {
				any_confederation_member = {
					NOT = {
						culture = root.culture
					}
				}
			}
			root.culture = {
				has_cultural_tradition = tradition_isolationist
			}
			add = 40
		}
		modifier = { #Bankrupt
			confederation = {
				any_confederation_member = {
					gold <= -1
				}
			}
			add = 10
		}
		modifier = { #All Bankrupt
			NOT = {
				confederation = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						gold <= -1
					}
				}
			}
			add = 50
		}
		modifier = { #Wide difference in rank
			highest_held_title_tier <= tier_county
			sub_realm_size <= 2
			add = -10
		}
		modifier = { #Wide difference in rank
			sub_realm_size <= 1
			add = -10
		}
		modifier = { # Is the Rightful Liege of recipient
			trigger = {
				confederation = {
					any_confederation_member = {
						is_rightful_liege_of = root
					}
				}
			}
			add = -20
		}
		modifier = { #No adjacency
			desc = offer_vassalization_interaction_aibehavior_unconnectedrealm_tt
			trigger = {
				NOT = {
					any_land_neighboring_realm_with_tributaries_owner = {
						OR = {
							is_member_of_confederation = root.confederation
							suzerain ?= {
								is_member_of_confederation = root.confederation
							}
						}
					}
				}
			}
			add = 100
		}
		modifier = { #Distant Realm
			desc = offer_vassalization_interaction_aibehavior_distantrealm_tt
			trigger = {
				NOR = {
					any_land_neighboring_realm_with_tributaries_owner = {
						OR = {
							is_member_of_confederation = root.confederation
							suzerain ?= {
								is_member_of_confederation = root.confederation
							}
						}
					}
					any_confederation_member = {
						NOT = {
							this = root
						}
						capital_province = {
							squared_distance = { target = root.capital_province value < 100000 }
						}
					}
				}
			}
			add = 150
		}
		modifier = { #Remote Realm.
			desc = offer_vassalization_interaction_aibehavior_remoterealm_tt
			trigger = {
				NOR = {
					any_land_neighboring_realm_with_tributaries_owner = {
						OR = {
							is_member_of_confederation = root.confederation
							suzerain ?= {
								is_member_of_confederation = root.confederation
							}
						}
					}
					any_confederation_member = {
						NOT = {
							this = root
						}
						capital_province = {
							squared_distance = { target = root.capital_province value < 200000 }
						}
					}
				}
			}
			add = 200
		}
		#Military strength higher than any member
		modifier = {
			NOT = {
				confederation = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						max_military_strength > root.max_military_strength
					}
				}
			}
			add = 20
		}
		#Military strength much higher than any member
		modifier = {
			NOT = {
				confederation = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						max_military_strength >= {
							value = {
								value = root.max_military_strength
								multiply = 2
							}
						}
					}
				}
			}
			add = 50
		}
		#Military strength lower than another member
		modifier = {
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					max_military_strength > root.max_military_strength
				}
			}
			add = -20
		}
		#Military strength lower than every other member
		modifier = {
			confederation = {
				NOT = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						max_military_strength < root.max_military_strength
					}
				}
			}
			add = -50
		}

		# MINOR
		modifier = { #Friend modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_friend = root
					}
				}
			}
			add = -25
		}
		modifier = { #Best Friend modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_best_friend = root
					}
				}
			}
			add = -50
		}
		modifier = { #Lover modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_lover = root
					}
				}
			}
			add = -10
		}
		modifier = { #Soulmate modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_soulmate = root
					}
				}
			}
			add = -50
		}
		modifier = { #Rivalry modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_rival = root
					}
				}
			}
			add = 200
		}
		modifier = { #Nemesis modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						has_relation_nemesis = root
					}
				}
			}
			add = 1000
		}
		modifier = { #Same Dynasty modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						exists = root.dynasty
						dynasty ?= root.dynasty
					}
				}
			}
			add = -20
		}
		modifier = { #Same House modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						exists = root.house
						house ?= root.dynasty
					}
				}
			}
			add = -50
		}

		modifier = { #Ageism modifier vs kids.
			trigger = {
				age >= 16
				NOT = {
					confederation = {
						any_confederation_member = {
							NOT = {
								this = root
							}
							age >= 16
						}
					}
				}
			}
			add = 25
		}
		modifier = { #Illegitimacy modifier.
			trigger = {
				confederation = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						OR = {
							AND = {
								has_trait = bastard
								root = {
									faith = { NOT = { has_doctrine = doctrine_bastardry_none } }
								}
							}
							has_trait = denounced
							has_trait = disinherited
						}
					}
				}
			}
			add = 10
		}
		
		modifier = { # Conqueror/GoK leaves immediately
			trigger = {
				root = {
					OR = {
						has_trait = conqueror
						has_trait = greatest_of_khans
					}
				}
			}
			add = 1000
		}

		modifier = { # Ambitious
			trigger = {
				root = {
					has_trait = ambitious
				}
			}
			add = 50
		}

		modifier = { # Paranoid
			trigger = {
				root = {
					has_trait = paranoid
				}
			}
			add = 20
		}

		modifier = { # Arrogant
			trigger = {
				root = {
					has_trait = arrogant
				}
			}
			add = 25
		}

		modifier = { # Fickle
			trigger = {
				root = {
					has_trait = fickle
				}
			}
			add = 50
		}

		modifier = { # Greedy
			trigger = {
				root = {
					has_trait = greedy
				}
			}
			add = 20
		}

		modifier = { # just
			trigger = {
				root = {
					has_trait = just
				}
			}
			add = -10
		}

		modifier = { # Trusting
			trigger = {
				root = {
					has_trait = trusting
				}
			}
			add = -20
		}

		modifier = { # Content
			trigger = {
				root = {
					has_trait = content
				}
			}
			add = -50
		}

		modifier = { # Craven
			trigger = {
				root = {
					has_trait = craven
				}
			}
			add = -50
		}

		# OPINION INFLUENCE
		modifier = {
			add = -25
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					root = {
						has_dread_level_towards = {
							target = prev
							level = 1
						}
					}
				}
			}
		}
		modifier = {
			add = -50
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					root = {
						has_dread_level_towards = {
							target = prev
							level = 2
						}
					}
				}
			}
		}
		modifier = { #Compare Opinion modifier.
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					reverse_opinion = {
						target = root
						value <= -50
					}
				}
			}
			add = 20
		}
		modifier = { #Compare Opinion modifier.
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					reverse_opinion = {
						target = root
						value <= -80
					}
				}
			}
			add = 20
		}
		modifier = { #Compare Opinion modifier.
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					reverse_opinion = {
						target = root
						value >= 80
					}
				}
			}
			add = -20
		}
		modifier = { #Compare Opinion modifier.
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					reverse_opinion = {
						target = root
						value >= 100
					}
				}
			}
			add = -20
		}

		# LOW LEGITIMACY
		modifier = {
			add = 5
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = reduced_vassalization_acceptance
				}
			}
		}
		modifier = {
			add = 10
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = very_reduced_vassalization_acceptance
				}
			}
		}
		modifier = {
			add = 20
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = massively_reduced_vassalization_acceptance
				}
			}
		}

		# HIGH LEGITIMACY
		modifier = {
			add = -5
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = increased_vassalization_acceptance
				}
			}
		}
		modifier = {
			add = -10
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = very_increased_vassalization_acceptance
				}
			}
		}
		modifier = {
			add = -25
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					has_legitimacy_flag = extra_increased_vassalization_acceptance
				}
			}
		}

		# PRESTIGE
		modifier = {
			add = 25
			prestige_level >= 4
		}
		modifier = {
			add = 25
			prestige_level >= 5
		}

		#CULTURE
		modifier = {
			add = -10
			confederation = {
				NOT = {
					any_confederation_member = {
						NOT = {
							culture = root.culture
						}
					}
				}
			}
		}
		modifier = {
			add = 50
			confederation = {
				NOT = {
					any_confederation_member = {
						NOT = {
							this = root
						}
						NOR = {
							culture = root.culture
							culture = {
								any_parent_culture_or_above = {
									this = root.culture
								}
							}
							root.culture = {
								any_parent_culture_or_above = {
									this = root.liege.culture
								}
							}
							culture = {
								has_same_culture_heritage = root.culture
							}
						}
					}
				}
			}
		}

		#Conquerors have no interest in this
		modifier = {
			root = {
				has_trait = conqueror
			}
			add = 500
		}
		modifier = {
			root = {
				has_trait = greatest_of_khans
			}
			add = 500
		}

		# Are you using a hook?
		modifier = {
			confederation = {
				any_confederation_member = {
					has_usable_hook = root
				}
			}
			add = -50
		}

		#No threat to confederate against
		modifier = {
			add = 75
			root = {
				NOT = {
					confederation_foe_trigger = { CHARACTER = root }
				}
			}
		}

		#Has confederation threat
		modifier = {
			add = -25
			root = {
				confederation_foe_trigger = { CHARACTER = root }
			}
		}

		#Neighbor is scaring them
		modifier = {
			add = -50
			root = {
				any_land_neighboring_realm_with_tributaries_owner = {
					top_suzerain = {
						NOR = {
							this = liege
							this = top_liege
						}
						confederation_worthy_foe_strength_ratio_value_root <= 0.25
						NOT = { is_allied_to = root }
						OR = {
							highest_held_title_tier >= tier_kingdom
							faith = {
								faith_hostility_level = {
									target = root.faith
									value >= faith_evil_level
								}
							}
							has_trait = conqueror
							has_trait = greatest_of_khans
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
			}
		}

		#Neighbor is TERRIFYING them
		modifier = {
			add = -100
			root = {
				any_land_neighboring_realm_with_tributaries_owner = {
					top_suzerain = {
						NOR = {
							this = liege
							this = top_liege
						}
						confederation_worthy_foe_strength_ratio_value_root <= 0.1
						NOT = { is_allied_to = root }
						OR = {
							highest_held_title_tier >= tier_kingdom
							faith = {
								faith_hostility_level = {
									target = root.faith
									value >= faith_evil_level
								}
							}
							has_trait = conqueror
							has_trait = greatest_of_khans
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
			}
		}

		#You have too many vassals
		modifier = {
			save_temporary_scope_as = actor
			scope:actor.confederation = {
				any_confederation_member = {
					count >= 6
					highest_held_title_tier >= tier_county
				}
			}
			add = {
				value = duchy_confederation_vassals_value
				multiply = -1
			}
		}

		#NOT FROM OFFER CONFEDERATION INTERACTION
		modifier = {
			confederation = {
				has_variable = confederation_culture
				var:confederation_culture = {
					this = root.culture
				}
			}
			add = -20
		}
		modifier = {
			confederation = {
				has_variable = confederation_culture
				var:confederation_culture = {
					NOT = { this = root.culture }
				}
			}
			add = 20
		}

		# C&L: Likely adding faith-based confederations/leagues, so adding this to cover that possibility
		modifier = {
			confederation = {
				has_variable = confederation_faith
				var:confederation_faith = {
					this = root.faith
				}
			}
			add = -20
		}
		modifier = {
			confederation = {
				has_variable = confederation_faith
				var:confederation_faith = {
					NOT = { this = root.faith }
				}
			}
			add = 20
		}

		modifier = {
			add = -50
			has_trait = loyal
		}
		modifier = {
			add = 50
			has_trait = disloyal
		}
		modifier = {
			has_trait = infirm
			add = -10
		}
		modifier = {
			confederation = {
				any_confederation_member = {
					NOT = {
						this = root
					}
					is_incapable = yes
				}
			}
			add = 15
		}
		#Confederation has only two
		modifier = {
			confederation = {
				any_confederation_member = {
					count <= 2
					highest_held_title_tier >= tier_county
				}
			}
			add = 20
		}
		#Doing great and doesn't need confederation
		modifier = {
			war_chest_gold >= war_chest_gold_maximum
			add = 25
		}
		modifier = {
			NOR = {
				any_land_neighboring_realm_with_tributaries_owner = {
					NOT = { is_allied_to = root }
				 	max_military_strength >= root.max_military_strength
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					suzerain ?= {
						NOT = { is_allied_to = root }
				 		max_military_strength >= root.max_military_strength
				 	}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					top_suzerain = {
						NOT = { is_allied_to = root }
				 		max_military_strength >= root.max_military_strength
				 	}
				}
			}
			add = 50
		}
		# C&L: As of now, I haven't changed the below domain_size checks. Might make them a little harsher for feudal/clan/etc, to hopefully prevent defensive leagues from getting too powerful. Need to check balancing
		modifier = {
			domain_size >= 4
			add = 15
		}
		modifier = {
			domain_size >= 5
			add = 20
		}
		modifier = {
			domain_size >= 6
			add = 25
		}
		modifier = {
			add = -10
			culture = {
				OR = {
					has_cultural_pillar = ethos_stoic
					has_cultural_pillar = ethos_communal
					has_cultural_pillar = ethos_egalitarian
				}
			}
		}
		modifier = {
			add = 10
			culture = {
				OR = {
					has_cultural_pillar = ethos_bellicose
					has_cultural_pillar = ethos_courtly
					has_cultural_pillar = ethos_bureaucratic
				}
			}
		}
		modifier = {
			add = 100
			ai_energy > low_negative_ai_value
			ai_boldness > low_negative_ai_value
			NOR = {
				has_trait = content
				has_trait = craven
				has_trait = loyal
				has_trait = humble
			}
			NOT = {
				has_character_flag = new_confederate
			}
		}
		#Recent AI confederates should really not take this
		modifier = {
			add = -500
			has_character_flag = new_confederate
		}
		modifier = {
			add = -25
			confederation = {
				any_confederation_member = {
					is_primary_heir_of = root
				}
			}
		}
		modifier = {
			add = -50
			confederation = {
				any_confederation_member = {
					root = {
						is_primary_heir_of = prev
					}
				}
			}
		}
		modifier = {
			add = -25
			confederation = {
				any_confederation_member = {
					any_spouse = {
						this = root
					}
				}
			}
		}
		modifier = {
			add = -25
			confederation = {
				any_confederation_member = {
					is_close_family_of = root
				}
			}
		}
		modifier = {
			add = -20
			confederation = {
				any_confederation_member = {
					any_spouse = {
						is_close_family_of = root
					}
				}
			}
		}
		modifier = {
			add = -20
			confederation = {
				any_confederation_member = {
					any_close_family_member = {
						any_spouse = {
							OR = {
								is_close_family_of = root
								this = root
							}
						}
					}
				}
			}
		}
	}
}

confederation_kingdom_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/mpo_decision_confederation.dds"
	}
	decision_group_type = major
	ai_check_interval = 12

	# C&L: Made name change depending on whether you are in a "League" or a "Confederation"
	title = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = league_kingdom_decision
			}
			desc = confederation_kingdom_decision
		}
	}

	# C&L: Made description change depending on whether you are in a "League" or a "Confederation"
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = league_kingdom_decision_desc
			}
			desc = confederation_kingdom_decision_desc
		}
	}

	# C&L: Made decision tooltip change depending on which type of confederation/league you are currently in
	selection_tooltip = {
		first_valid = {
			triggered_desc = {
				trigger = {
					confederation = {
						has_variable = confed_type
						var:confed_type = flag:CL_type_league
					}
				}
				desc = league_kingdom_decision_tooltip
			}
			desc = confederation_kingdom_decision_tooltip
		}
	}

	is_shown = {
		is_confederation_member = yes
		is_landed = yes
		is_playable_character = yes
	}

	is_valid = {
		prestige_level >= 3
		is_independent_ruler = yes
		# C&L: Made these tooltips change depending on whether you are in a confederation or a league
		trigger_if = { # C&L: In a Defensive League
			limit = {
				confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_league
				}
			}
			custom_tooltip = {
				text = league_kingdom_decision_vassal_req
				confederation = {
					any_confederation_member = {
						highest_held_title_tier >= tier_county
						count >= 5
					}
				}
			}
			custom_tooltip = {
				text = league_kingdom_decision_vassal_opinion_req
				NOT = {
					confederation = {
						any_confederation_member = {
							this != root
							opinion = {
								target = root
								value < 25
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = league_kingdom_decision_vassal_prestige_level_req
				NOT = {
					confederation = {
						any_confederation_member = {
							this != root
							prestige_level >= root.prestige_level
						}
					}
				}
			}
		}
		trigger_else_if = { # C&L: In a Confederation
			limit = {
				confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_confederation
				}
			}
			custom_tooltip = {
				text = confederation_kingdom_decision_vassal_req
				confederation = {
					any_confederation_member = {
						highest_held_title_tier >= tier_county
						count >= 5
					}
				}
			}
			custom_tooltip = {
				text = confederation_kingdom_decision_vassal_opinion_req
				NOT = {
					confederation = {
						any_confederation_member = {
							this != root
							opinion = {
								target = root
								value < 25
							}
						}
					}
				}
			}
			custom_tooltip = {
				text = confederation_kingdom_decision_vassal_prestige_level_req
				NOT = {
					confederation = {
						any_confederation_member = {
							this != root
							prestige_level >= root.prestige_level
						}
					}
				}
			}
		}
		# C&L: Right now, the conditions are the same for confederations and defensive leagues. Might change them later to maybe make it a little harder for defensive leagues to do this decision
	}

	is_valid_showing_failures_only = {
		is_available_adult = yes
		is_at_war = no
		is_tributary = no
		# C&L: Made this tooltip change depending on whether you are in a confederation or a league
		trigger_if = { # C&L: In a Defensive League
			limit = {
				confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_league
				}
			}
			custom_tooltip = {
				text = league_kingdom_decision_vassal_wars_req
				NOT = {
					confederation = {
						any_confederation_member = { is_at_war = yes }
					}
				}
			}
		}
		trigger_else_if = { # C&L: In a Confederation
			limit = {
				confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_confederation
				}
			}
			custom_tooltip = {
				text = confederation_kingdom_decision_vassal_wars_req
				NOT = {
					confederation = {
						any_confederation_member = { is_at_war = yes }
					}
				}
			}
		}
	}

	cost = {
		prestige = {
			value = {
				add = 0
				if = {
					limit = {
						# C&L: The base game just checks if the government has the tribal flag. For now, will just make this the option for all non-Nomadic rulers. Will likely change this later to make it harder for Defensive Leagues
						NOT = { government_has_flag = government_is_nomadic }
					}
					add = medium_prestige_value
				}
			}
		}
		herd = {
			value = {
				add = 0
				if = {
					limit = {
						government_has_flag = government_is_nomadic
					}
					add = medium_herd_value_static
				}
			}
		}
	}

	effect = {
		# C&L: Made this tooltip properly reflect whether you were in a confederation or a league
		if = {
			limit = {
				confederation = {
					has_variable = confed_type
					var:confed_type = flag:CL_type_league
				}
			}
			custom_tooltip = league_kingdom_creation_tt
		}
		else = {
			custom_tooltip = confederation_kingdom_creation_tt
		}
		custom_tooltip = confederation_succession_tt
		custom_tooltip = confederation_king_modifier_tt
		custom_tooltip = confederation_vassal_modifier_tt
		custom_tooltip = confederation_county_modifier_tt
		save_scope_as = new_king_ruler
		hidden_effect = {
			confederation = {
				save_scope_as = old_confederation
				every_confederation_member = {
					add_to_list = confederation_vassals
					every_tributary = {
						limit = {
							highest_held_title_tier <= tier_duchy
						}
						add_to_list = confederation_vassals
					}
				}
			}
			primary_title = {
				save_scope_as = old_title
			}
			save_scope_as = confederation_offerer
			# C&L: The base game always makes this kingdom title use the culture-based confederation name, which can lead to weird name changes from the old confederation to the new elevated kingdom title. This scripted effect instead determines what the actual name should be, and makes the title, outputting the title to scope:new_title. TITLE_TIER will pretty much always be kingdom, but if I allow kingdoms into confederations/leagues, might need to look into allowing empires to be created through this decision as well.
			CL_determine_elevated_title_name = {
				TITLE_TIER = kingdom
			}
			# C&L: Here, base game also assigns the character's culture as the confederation_culture variable in the new title. That stuff is being handled in the above scripted_effect
			
			scope:new_title = {
				set_color_from_title = root.capital_county
				set_definitive_form = yes
			}
			
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
				add_claim_on_loss = no
			}
			scope:new_title = {
				set_destroy_on_gain_same_tier = yes
				set_no_automatic_claims = yes
				set_can_be_named_after_dynasty = no
				set_can_use_nomadic_naming = no
				change_title_holder = {
					holder = root
					change = scope:change
				}
			}
			every_in_list = {
				list = confederation_vassals
				change_liege = {
					liege = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
				add_claim_on_loss = no
			}
			every_in_list = {
				list = confederation_vassals
				limit = {
					NOT = {
						this = root
					}
				}
				if = {
					limit = {
						has_government = herder_government
					}
					every_held_title = {
						limit = {
							tier = tier_county
							title_province = {
								has_holding_type = herder_holding
							}
						}
						title_province = {
							set_holding_type = nomad_holding
						}
					}
					change_government = nomad_government
				}
				change_liege = {
					liege = root
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			

			scope:new_title = {
				generate_coa = yes
				add_title_law = confederation_elective_succession_law
				set_capital_county = root.capital_county
			}
			set_primary_title_to = scope:new_title
			confederation = {
				disband_confederation = yes
			}

			# C&L: Some historical confederations/leagues should have a new culture created for them
			if = {
				limit = {
					scope:new_title = { has_variable = historical_confed_league }
				}

				switch = {
					trigger = scope:new_title.var:historical_confed_league

					flag:cl_masmuda_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = masmuda_name
								collective_noun = masmuda_collective_noun
								prefix = masmuda_prefix
							}
						}
					}
					flag:cl_zenati_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = zenati_name
								collective_noun = zenati_collective_noun
								prefix = zenati_prefix
							}
						}
					}
					flag:cl_sanhaja_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = sanhaja_name
								collective_noun = sanhaja_collective_noun
								prefix = sanhaja_prefix
							}
						}
					}
					flag:cl_kabyle_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = kabyle_name
								collective_noun = kabyle_collective_noun
								prefix = kabyle_prefix
							}
						}
					}
					flag:cl_chaoui_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = chaoui_name
								collective_noun = chaoui_collective_noun
								prefix = chaoui_prefix
							}
						}
					}
					flag:cl_mozabite_confederacy = {
						create_divergent_culture = yes
						scope:new_culture = {
							set_culture_name = {
								noun = mozabite_name
								collective_noun = mozabite_collective_noun
								prefix = mozabite_prefix
							}
						}
					}
				}

				if = {
					limit = { exists = scope:new_culture }

					every_vassal_or_below = {
						if = {
							limit = {
								culture = { has_same_culture_heritage = root.culture }
							}

							set_culture_same_as = root
							capital_county = { set_county_culture = scope:new_culture } # C&L: Get some initial conversion so the new culture doesn't just immediately get wiped out
						}

						every_courtier = {
							if = {
								limit = {
									culture = { has_same_culture_heritage = root.culture }
								}

								set_culture_same_as = root
							}
						}
					}
					every_courtier = {
						if = {
							limit = {
								culture = { has_same_culture_heritage = root.culture }
							}

							set_culture_same_as = root
						}
					}
				}
			}

			every_in_list = {
				list = confederation_vassals
				limit = {
					this != root
				}
				trigger_event = mpo_decisions_events.0004
			}
			trigger_event = mpo_decisions_events.0005
		}
	}

	ai_potential = {
		is_confederation_member = yes
	}

	ai_will_do = {
		base = 100
	}
}
