# This decision is pretty much copy-paste of the base game call_for_confederation_decision decision, comments with C&L are pretty much just showing the differences between the two
call_for_league_decision = {
	picture = {
		reference = "gfx/interface/illustrations/decisions/mpo_decision_confederation.dds"
	}
	decision_group_type = major
	
	ai_check_interval_by_tier = {
		barony = 0
		county = 8
		duchy = 8
		kingdom = 8 # C&L: Base game has this as 0, preventing kings from taking this decision
		empire = 0
		hegemony = 0
	}

	desc = call_for_confederation_decision_desc
	selection_tooltip = call_for_league_decision_tooltip # C&L: Different tooltip for defensive leagues
	confirm_text = call_for_confederation_decision_confirm

	is_shown = {
		CL_has_appropriate_title_tier = yes # C&L: Changed this from allowing just duchies and below to instead changing depending on what game rule the player has set
		CL_uses_leagues = yes # C&L: Base game just checks if you are Tribal/Nomadic. Changed it to check that you have any of the valid governments for defensive leagues
		is_playable_character = yes
		is_independent_ruler = yes
		NOR = {
			has_character_flag = forming_confederation
			is_confederation_member = yes
		}
	}

	is_valid = {
		is_independent_ruler = yes
		CL_has_appropriate_title_tier = yes # C&L: Changed this from allowing just duchies and below to instead changing depending on what game rule the player has set
		is_tributary = no
		custom_tooltip = { # C&L: Need to have a relevant government for creating a defensive league
			CL_uses_leagues = yes
			text = CL_has_valid_league_government_tt
		}
		CL_has_appropriate_realm_laws = yes # C&L: Base game just checks if you have Nomadic government, and fallsback to assuming you are Tribal. I changed it so that it now checks what realm law you use, and makes sure you only have the relevant laws
		NOR = {
			has_trait = conqueror
			has_trait = greatest_of_khans
		}
		trigger_if = {
			limit = {
				NOT = {
					culture = {
						has_cultural_parameter = forming_confederations_is_easier 
					}
				}
			} #When adjusting, adjust culture_parameter_forming_confederations_is_easier string
			OR = {
				has_trait = diplomat
				has_trait = family_first
				confederation_foe_trigger = { CHARACTER = root }
			}
		}
		#This is just meant to stop player exploits
		trigger_if = { # C&L: Made this tooltip change depending on whether you will be in a Defensive League or Confederation
			limit = {
				is_ai = no
				CL_uses_leagues = yes
			}
			custom_tooltip = {
				text = recently_took_leave_league_decision_tt
				NOT = { has_variable = left_confederation }
			}
		}
		trigger_else_if = {
			limit = {
				is_ai = no
				CL_uses_confederations = yes
			}
			custom_tooltip = {
				text = recently_took_leave_confederation_decision_tt
				NOT = { has_variable = left_confederation }
			}
		}
	}
	cooldown = { years = 5 }

	is_valid_showing_failures_only = {
		age >= 6
		trigger_if = {
			limit = {
				is_ai = no
			}
			NOT = { exists = involved_activity }
			NOT = { has_trait = infirm }
			is_physically_able = yes
			is_travelling = no
		}
		trigger_else = {
			is_imprisoned = no
			is_incapable = no
			is_alive = yes
			is_migrating = no
			NOT = { has_trait = infirm }
		}
	}

	cost = {
		prestige = {
			value = {
				add = 100
				if = {
					limit = {
						highest_held_title_tier = tier_duchy
					}
					add = 200
				}
				if = {
					limit = {
						highest_held_title_tier = tier_kingdom # C&L: The base game increases the cost for duchies, so added this to further increase the cost for kingdoms
					}
					add = 300
				}
				if = {
					limit = {
						max_military_strength > 0
						any_neighboring_top_liege_realm_owner = {
							NOT = { is_allied_to = root }
							max_military_strength > 0
							confederation_worthy_foe_strength_ratio_value_root <= 0.5
						}
					}
					add = -50
				}
				if = {
					limit = {
						max_military_strength > 0
						any_neighboring_top_liege_realm_owner = {
							NOT = { is_allied_to = root }
							max_military_strength > 0
							confederation_worthy_foe_strength_ratio_value_root <= 0.25
						}
					}
					add = -50
				}
			}
		}
		piety = {
			value = {
				add = 250
			}
		}
	}

	effect = {
		# C&L: Made tooltips be based around forming a "League"
		custom_tooltip = enables_offer_league_tt
		custom_tooltip = offer_league_members_tt
		custom_tooltip = league_join_defensive_wars_tt
		custom_tooltip = league_raiding_attacking_tt
		custom_tooltip = offer_league_5_year_warning_tt
		if = {
			limit = {
				government_has_flag = government_is_nomadic
			}
			custom_tooltip = confederation_modifier_tt
		}
		# C&L: Base game just checks if you have Nomadic government, and fallsback to assuming you are Tribal. I changed it so that it now checks what realm law you use, and notifies you that that specific realm law will be limited
		if = {
			limit = {
				realm_law_use_nomadic_authority = yes
			}
			custom_tooltip = confederation_restrictions_warning_tt
		}
		else_if = {
			limit = {
				realm_law_use_tribal_authority = yes
			}
			custom_tooltip = confederation_restrictions_tribe_warning_tt
		}
		else_if = {
			limit = {
				realm_law_use_crown_authority = yes
			}
			custom_tooltip = league_restrictions_crown_authority_warning_tt
		}
		custom_tooltip = league_leaving_warning_tt # C&L: Changed to better fit defensive leagues
		# C&L: To better reference whether you are trying to form a confederation or league later
		save_scope_value_as = {
			name = new_CL_type
			value = flag:defensive_league
		}
		trigger_event = mpo_decisions_events.0001
	}

	ai_potential = {
		# C&L: Checks if they have a government that can actually join defensive leagues
		CL_uses_leagues = yes
		is_independent_ruler = yes
		CL_has_appropriate_title_tier = yes # C&L: Changed this from allowing just duchies and below to instead changing depending on what game rule the player has set
		is_tributary = no
		is_playable_character = yes
		is_confederation_member = no
		is_alive = yes
		#Culture friends # C&L: This requires that the AI has at least two neighbors of the same culture who either: have the same faith; also have unreformed faiths; or whose faith doesn't view their own faith as Hostile/Evil. Might add an alternative to this so that they don't need to same-culture neighbors as long as their neighbors have the same faith with certain tenants, so they could maybe form a faith-based confederation/league instead of a culture-based one. (Will likely also need to make the below neighbor check inside its own scripted trigger so that it could be referenced later when deciding whether to make the confederations/leagues culture- or faith-based)
		any_land_neighboring_realm_with_tributaries_owner = {
			count >= 2
			culture = root.culture
			OR = {
				faith = root.faith
				AND = {
					faith = {
						has_doctrine_parameter = unreformed
					}
					root.faith = {
						has_doctrine_parameter = unreformed
					}
				}
				faith = {
					faith_hostility_level = {
						target = root.faith
						value < faith_hostile_level
					}
				}
			}
			valid_defensive_league_member_trigger = { CHARACTER = root } # C&L: Changed to check if they are a valid member for defensive leagues
			NOT = {
				has_any_bad_relationship_with_character_trigger = { CHARACTER = root }
			}
		}
	}

	ai_will_do = {
		base = 0
		modifier = {
			ai_compassion >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_honor >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_boldness <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_sociability >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_greed <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_energy <= low_negative_ai_value
			add = 5
		}
		modifier = {
			ai_rationality >= low_positive_ai_value
			add = 5
		}
		modifier = {
			ai_compassion <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_honor <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_boldness >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_sociability <= low_negative_ai_value
			add = -5
		}
		modifier = {
			ai_greed >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_energy >= low_positive_ai_value
			add = -5
		}
		modifier = {
			ai_rationality <= low_negative_ai_value
			add = -5
		}
		modifier = {
			OR = {
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					confederation_worthy_foe_strength_ratio_value_root <= 0.25
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					is_tributary = yes
					top_suzerain = {
						confederation_worthy_foe_strength_ratio_value_root <= 0.25
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_confederation_member = no
					is_tributary = yes
					suzerain ?= {
						confederation_worthy_foe_strength_ratio_value_root <= 0.25
					}
				}
			}
			add = 25
		}
		modifier = {
			confederation_neighboring_foe_trigger = { CHARACTER = root }
			add = 30
		}
		modifier = {
			OR = {
				any_land_neighboring_realm_with_tributaries_owner = {
					OR = {
						has_trait = greatest_of_khans
						has_trait = conqueror
						any_owned_story = {
							OR = {
								story_type = story_greatest_of_khans
								story_type = story_mongol_invasion
							}
						}
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					top_suzerain = {
						OR = {
							has_trait = greatest_of_khans
							has_trait = conqueror
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
				any_land_neighboring_realm_with_tributaries_owner = {
					is_tributary = yes
					suzerain ?= {
						OR = {
							has_trait = greatest_of_khans
							has_trait = conqueror
							any_owned_story = {
								OR = {
									story_type = story_greatest_of_khans
									story_type = story_mongol_invasion
								}
							}
						}
					}
				}
			}
			add = 50
		}
		modifier = {
			add = 10
			culture = {
				OR = {
					has_cultural_pillar = ethos_stoic
					has_cultural_pillar = ethos_communal
					has_cultural_pillar = ethos_egalitarian
				}
			}
		}
		modifier = {
			add = -20
			culture = {
				OR = {
					has_cultural_pillar = ethos_bellicose
					has_cultural_pillar = ethos_courtly
					has_cultural_pillar = ethos_bureaucratic
				}
			}
		}
		modifier = {
			add = -100
			prestige <= medium_prestige_value # You cannot afford this
		}
		#Another confederation of your culture already exists
		modifier = {
			any_confederation = {
                confederation_type = confederation_type:defensive_league_type # C&L: Added this condition so that it only checks existing "Defensive Leagues"
				has_variable = confederation_culture
				var:confederation_culture = root.culture
			}
			factor = 0.05
		}
		# C&L: Adding in the possibility that another confederation/league already exists that is based around your faith (will likely need to add an additional trigger that makes this only apply if their faith is capable of making faith-based leagues, and will likely need to modify how much this, and the above modifier, factors the ai_will_do chance, so that they aren't as harsh)
		#Another confederation of your faith already exists
		modifier = {
			any_confederation = {
                confederation_type = confederation_type:defensive_league_type # C&L: Added this condition so that it only checks existing "Defensive Leagues"
				has_variable = confederation_faith
				var:confederation_faith = root.faith
			}
			factor = 0.05
		}
		#There's already another confederation nearby
		modifier = {
			any_confederation = {
                confederation_type = confederation_type:defensive_league_type # C&L: Added this condition so that it only checks existing "Defensive Leagues"
				is_house_based = no # any_confederation_member is not performant for house blocs
				any_confederation_member = { in_diplomatic_range = root }
			}
			factor = 0.1
		}
		modifier = {
			add = 300
			culture = { has_cultural_parameter = forming_confederations_is_easier }
		}
	}
}
